name: Flutter CI/CD  
  
on:  
  push:  
    tags:  
      - 'v*' # 只对以 'v' 开头的 tag 触发构建  
  
jobs:  
  build-and-release:  
    name: Build and Release  
    runs-on: macos-latest # macOS 用于构建 iOS 应用  
  
    steps:  
      - uses: actions/checkout@v2  
  
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.2'

      - name: Set up JDK 11  
        uses: actions/setup-java@v2  
        with:  
          java-version: '11'  
          distribution: 'temurin'
  
      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
  
      - name: Get packages
        run: flutter pub get
  
      - name: Run tests
        run: flutter test
   
      - name: Build Android APK  
        run: flutter build apk
  
      - name: Build Android App Bundle (AAB)  
        run: flutter build appbundle
  
      - name: Build iOS app  
        run: |  
          flutter clean  
          flutter build ios --release --no-codesign

      - name: Create IOS Release Artifacts  
        run: |  
          mkdir artifacts  
          cp -r build/ios/iphoneos/Runner.app artifacts/Runner.app  
          zip -r artifacts/Runner.ipa artifacts/Runner.app  

      # 提取版本号
      - name: Extract version from tag  
        run: |  
          VERSION=${GITHUB_REF#refs/tags/}  
          echo "VERSION=$VERSION" >> $GITHUB_ENV  
      - name: Create Release  
        id: create_release  
        uses: actions/create-release@v1  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        with:  
          tag_name: ${{ env.VERSION }}  
          release_name: Release ${{ env.VERSION }}  
          draft: false  
          prerelease: false  

      - name: Upload iOS IPA to Release  
        id: upload-ipa-release-asset  
        uses: actions/upload-release-asset@v1  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        with:  
          upload_url: ${{ steps.create_release.outputs.upload_url }}  
          asset_path: ./artifacts/Runner.ipa  
          asset_name: Runner.ipa  
          asset_content_type: application/zip    
  
      - name: Upload Android APK to Release  
        id: upload-apk-release-asset  
        uses: actions/upload-release-asset@v1  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        with:  
          upload_url: ${{ steps.create_release.outputs.upload_url }}  
          asset_path: ./build/app/outputs/flutter-apk/app-release.apk    
          asset_name: app-release.apk  
          asset_content_type: application/vnd.android.package-archive  
  
      - name: Upload Android App Bundle (AAB) to Release  
        id: upload-aab-release-asset  
        uses: actions/upload-release-asset@v1  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        with:  
          upload_url: ${{ steps.create_release.outputs.upload_url }}  
          asset_path: ./build/app/outputs/bundle/release/app-release.aab  
          asset_name: app-release.aab  
          asset_content_type: application/octet-stream  
  
     